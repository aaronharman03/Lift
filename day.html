<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Workout Day</title>
  <style>
    /* [your existing CSS unchanged] */
    /* ...everything stays the same... */
  </style>
</head>
<body>

<header>
  <button class="btn-back" onclick="goBack()">← Back to Days</button>
  <button id="viewGraphBtn">View Progress Graph</button>
</header>

<h1 id="dayTitle">Workout Day</h1>

<div id="exercisesList"></div>

<button id="addExerciseBtn">Add Exercise</button>

<!-- Modal -->
<div id="modalOverlay"></div>
<div id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <h2 id="modalTitle">Add Exercise</h2>
  <form id="exerciseForm">
    <input type="text" id="exerciseName" placeholder="Exercise Name" required autocomplete="off" />
    <div id="weight-container">
      <input type="number" id="weight" placeholder="Weight" min="0" step="0.25" autocomplete="off" />
      <button type="button" id="weightUnitBtn">kg</button>
    </div>
    <select id="numSets" required>
      <option value="">Select Sets</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>
    <div id="repsInputs" style="margin-bottom: 15px;"></div>
    <div id="modalButtons">
      <button type="submit" id="saveBtn">Save</button>
      <button type="button" id="cancelBtn">Cancel</button>
    </div>
    <button type="button" id="deleteBtn" style="display:none;">Delete</button>
  </form>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBeY7gbFGHJFWlIqVuEGUoaaDTBagsJLZw",
  authDomain: "gym-app-4fff1.firebaseapp.com",
  projectId: "gym-app-4fff1",
  storageBucket: "gym-app-4fff1.appspot.com",
  messagingSenderId: "1009678266608",
  appId: "1:1009678266608:web:430ec88c296133a6b39235",
  measurementId: "G-E0TDYJLMXH"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const userId = "demoUser"; // Customize if needed
</script>

<script>
const params = new URLSearchParams(location.search);
const day = params.get('day') || '1';
document.getElementById('dayTitle').textContent = `Workout Day ${day}`;

const exercisesListEl = document.getElementById('exercisesList');
const modal = document.getElementById('modal');
const modalOverlay = document.getElementById('modalOverlay');
const addExerciseBtn = document.getElementById('addExerciseBtn');
const viewGraphBtn = document.getElementById('viewGraphBtn');

const exerciseForm = document.getElementById('exerciseForm');
const exerciseNameInput = document.getElementById('exerciseName');
const weightInput = document.getElementById('weight');
const weightUnitBtn = document.getElementById('weightUnitBtn');
const numSetsSelect = document.getElementById('numSets');
const repsInputsDiv = document.getElementById('repsInputs');
const saveBtn = document.getElementById('saveBtn');
const cancelBtn = document.getElementById('cancelBtn');
const deleteBtn = document.getElementById('deleteBtn');
const modalTitle = document.getElementById('modalTitle');

let exercises = [];
let editingIndex = null;
let currentWeightUnit = 'kg';

function saveExercisesToFirebase() {
  db.ref(`users/${userId}/days/${day}`).set(exercises);
}

function loadExercisesFromFirebase() {
  db.ref(`users/${userId}/days/${day}`).once('value').then(snapshot => {
    exercises = snapshot.val() || [];
    renderExercises();
  });
}

function renderExercises() {
  exercisesListEl.innerHTML = '';
  if (exercises.length === 0) {
    exercisesListEl.textContent = 'No exercises logged yet.';
    return;
  }

  exercises.forEach((ex, idx) => {
    const repsStr = ex.reps && ex.reps.length
      ? ex.reps.filter(r => r != null && r !== '').join(',') : 'N/A';

    const unit = ex.weightUnit || 'kg';

    const div = document.createElement('div');
    div.className = 'exercise-line';
    div.title = 'Click to edit exercise';
    div.tabIndex = 0;
    div.setAttribute('role', 'button');

    const span = document.createElement('span');
    span.className = 'exercise-text';
    span.textContent = `${ex.name} - ${ex.weight || '0'}${unit} - ${repsStr}`;

    div.appendChild(span);
    div.addEventListener('click', () => openModalForEdit(idx));
    div.addEventListener('keypress', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openModalForEdit(idx);
      }
    });

    exercisesListEl.appendChild(div);
  });
}

function openModalForAdd() {
  editingIndex = null;
  modalTitle.textContent = 'Add Exercise';
  exerciseForm.reset();
  repsInputsDiv.innerHTML = '';
  deleteBtn.style.display = 'none';
  currentWeightUnit = 'kg';
  weightUnitBtn.textContent = currentWeightUnit;
  showModal();
}

function openModalForEdit(index) {
  editingIndex = index;
  const ex = exercises[index];
  modalTitle.textContent = 'Edit Exercise';
  exerciseNameInput.value = ex.name;
  weightInput.value = ex.weight || '';
  currentWeightUnit = ex.weightUnit || 'kg';
  weightUnitBtn.textContent = currentWeightUnit;
  numSetsSelect.value = ex.reps.length;
  generateRepsInputs(ex.reps.length, ex.reps);
  deleteBtn.style.display = 'block';
  showModal();
}

function generateRepsInputs(num, existingReps=[]) {
  repsInputsDiv.innerHTML = '';
  for (let i = 0; i < num; i++) {
    const input = document.createElement('input');
    input.type = 'number';
    input.min = '0';
    input.placeholder = `Reps set ${i + 1}`;
    input.required = true;
    input.value = existingReps[i] || '';
    input.autocomplete = 'off';
    repsInputsDiv.appendChild(input);
  }
}

function showModal() {
  modal.style.display = 'block';
  modalOverlay.style.display = 'block';
  exerciseNameInput.focus();
}
function hideModal() {
  modal.style.display = 'none';
  modalOverlay.style.display = 'none';
}

addExerciseBtn.addEventListener('click', openModalForAdd);

cancelBtn.addEventListener('click', e => {
  e.preventDefault();
  hideModal();
});

modalOverlay.addEventListener('click', hideModal);

numSetsSelect.addEventListener('change', () => {
  const num = parseInt(numSetsSelect.value, 10);
  if (!isNaN(num)) {
    generateRepsInputs(num);
  } else {
    repsInputsDiv.innerHTML = '';
  }
});

exerciseForm.addEventListener('submit', e => {
  e.preventDefault();

  const name = exerciseNameInput.value.trim();
  const weight = weightInput.value.trim();
  const weightVal = weight === '' ? 0 : parseFloat(weight);
  const weightUnit = currentWeightUnit;
  const numSets = parseInt(numSetsSelect.value, 10);

  if (!name || isNaN(numSets) || numSets <= 0) {
    alert('Please enter all required fields.');
    return;
  }

  const reps = [];
  const inputs = repsInputsDiv.querySelectorAll('input');
  for (const input of inputs) {
    const val = input.value.trim();
    if (val === '' || isNaN(parseInt(val, 10))) {
      alert('Please enter valid reps for all sets.');
      return;
    }
    reps.push(parseInt(val, 10));
  }

  const exerciseData = { name, weight: weightVal, weightUnit, reps };

  if (editingIndex !== null) {
    exercises[editingIndex] = exerciseData;
  } else {
    exercises.push(exerciseData);
  }

  saveExercisesToFirebase();

  // ✅ Save to log
  const logEntry = {
    name: exerciseData.name,
    weight: exerciseData.weight,
    weightUnit: exerciseData.weightUnit || 'kg',
    reps: exerciseData.reps || [],
    date: new Date().toISOString().split('T')[0]
  };
  db.ref(`users/${userId}/logs`).push(logEntry);

  renderExercises();
  hideModal();
});

deleteBtn.addEventListener('click', () => {
  if (editingIndex !== null && confirm('Delete this exercise?')) {
    exercises.splice(editingIndex, 1);
    saveExercisesToFirebase();
    renderExercises();
    hideModal();
  }
});

weightUnitBtn.addEventListener('click', () => {
  currentWeightUnit = currentWeightUnit === 'kg' ? 'lb' : 'kg';
  weightUnitBtn.textContent = currentWeightUnit;
});

function goBack() {
  location.href = 'index.html';
}

viewGraphBtn.addEventListener('click', () => {
  location.href = `graph.html?day=${day}`;
});

// Initial load
loadExercisesFromFirebase();
</script>
</body>
</html>


